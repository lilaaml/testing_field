{% extends 'base.html' %}
{% block content %}

<h3 class="fw-bold">{{ form_title }}</h3>
<form method="post" id="proposalForm" class="my-3">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="mb-3">
        {{ form.client.label_tag }}
        {{ form.client }}
    </div>
    <div class="mb-3">
        {{ form.audit_type.label_tag }}
        {{ form.audit_type }}
    </div>

    <input type="hidden" name="fye_data" id="fye-data">

    <h3 class="mt-4">Fiscal Year End</h3>
    <div id="fye-fields" class="d-flex flex-column gap-2">
        <div class="fye-row d-flex gap-2">
            <input type="date" class="fye-input form-control">
            <button type="button" class="btn btn-outline-danger delete-btn">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>

    <button type="button" id="add-fye" class="btn btn-outline-secondary mt-2 mb-3">
        <i class="bi bi-plus-lg"></i> Tambah Tahun Buku
    </button>

    <p id="fye-error" class="text-danger mt-2 d-none"></p>

    <div class="mb-3">
        <label for="base" class="form-label">Base Fee</label>
        <input type="text" name="base" id="base-input" class="form-control" required>
    </div>
    <div class="mb-3">
        <label for="assist" class="form-label">Base Fee</label>
        <input type="text" name="assist" id="assist-input" class="form-control">
    </div>
    <div class="mb-3">
        <label for="ope" class="form-label">Base Fee</label>
        <input type="text" name="ope" id="ope-input" class="form-control">
    </div>

    {{ form.base_fee }}
    {{ form.assistance_fee }}
    {{ form.ope_fee }}

    <div class="mb-3">
        <label class="form-label">Jumlah Termin</label>
        <select id="termin-count" class="form-select"></select required>
            <option value="">--- Pilih ---</option>
            <option value="2">Dua Termin</option>
            <option value="3">Tiga Termin</option>
            <option value="4">Empat Termin</option>
    </div>

    {{ form.num_termins }}
    {{ form.termin_values }}
    {{ form.total_percentage }}
    {{ form.total_fee }}
    {{ form.termin_fee }}

    <div id="termin-container" class="mb-3"></div>

    <div id="sub-fee-display" class="mb-3"></div>

    <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary flex-fill">Save</button>
        <a href="#" class="btn btn-secondary flex-fill">Cancel</a>
    </div>
</form>

<script>
    var dateArray = {{ existing_dates_json|default:"[]"|safe }}
</script>

<script id="default-termin-opt" type="application/json">
    {
        "2": [50, 50],
        "3": [30, 40, 30],
        "4": [null, null, null, null],
    }
</script>

<script>
    const form = document.getElementById("proposalForm");

    const fyeWrapper = document.getElementById("fye-fields");
    const addFye = document.getElementById("add-fye");
    const hiddenFye = document.getElementById("fye-data");
    const errorFye = document.getElementById("fye-error");

    const terminDefaults = JSON.parse(document.getElementById("default-termin-opt").textContent);
    // Visible Fee
    const baseVisible = document.getElementById("base-input");
    const assistVisible = document.getElementById("assist-input");
    const opeVisible = document.getElementById("ope-input");
    // Hidden Fee
    const baseHidden = document.getElementById("base_fee");
    const assistHidden = document.getElementById("assistance_fee");
    const opeHidden = document.getElementById("ope_fee");
    // Termin
    const terminSelect = document.getElementById("termin-count");
    const container = document.getElementById("termin-container");
    const numTerminsHidden = document.getElementById("num_termins");
    const terminValHidden = document.getElementById("termin_values");
    const totalPercentHidden = document.getElementById("total_percentage");
    const totalFeeHidden = document.getElementById("total_fee");
    const terminFeeHidden = document.getElementById("termin_fee");

    let inputElements = [];
    let totalDisplay;
    let warning;

    // Check if hidden field store the correct data
    hiddenFye.value = JSON.stringify(dateArray);

    // Auto-fill + Add + Delete (FYE)
    function renderFye(dates) {
        fyeWrapper.innerHTML = ""; // Clear UI

        dates.forEach((val, i) => {
            const row = document.createElement("div");
            row.className = "d-flex align-items-center gap-2 mb-2";

            row.innerHTML =
                `<input
                    type="date"
                    class="form-control fye-input"
                    value="${val}"
                    style="max=width: 200px;"
                >
                <button type="button"
                class="btn btn-outline-danger btn-sm remove-fye>
                    <i class="bi bit-trash"></i>
                </button>
            `;

            fyeWrapper.appendChild(row);

            row.querySelector(".remove-fye").addEventListener("click", function() {
                dates.splice(i, 1);
                renderFye(dates);
            });
        });

        hiddenFye.value = JSON.stringify(dates);
    }

    addFye.addEventListener("click", function() {
        dateArray.push("");
        renderFye(dateArray);
    });

    terminSelect.addEventListener("change", () => {
        const num = parseInt(terminSelect.value);
        container.innerHTML = "";
        inputElements = [];

        if (!num) {
            numTerminsHidden.value = "";
            return;
        }

        numTerminsHidden.value = num;
        const val = defaults[num];

        totalDisplay = document.createElement("p");
        totalDisplay.classList.add("fw-bold", "mt-3");
        totalDisplay.textContent = "Total: 0%";

        warning = document.createElement("div");
        warning.classList.add("alert", "alert-warning", "mt-2");
        warning.style.display = "none";

        container.appendChild(totalDisplay);

        const table = document.createElement("table");
        table.classList.add("table", "table-bordered", "text-center", "termin-table", "mt-2");

        table.innerHTML = `
            <thead class="table-primary">
                <tr>
                    <th>Termins</th>
                    <th>%</th>
                    <th>Total</th>
                    <th>Per Termin</th>
                </tr>
            </thead>
        `;

        const tbody = document.createElement("tbody");

        val.forEach((v, i) => {
            const tr = document.createElement("tr");

            const nameCell = `<td class="fw-semibold">Termin ${i+1}</td>`;

            const percentInput = document.createElement("input");
            percentInput.type = "number";
            percentInput.classList.add("form-control", "text-center", "mx-auto");
            percentInput.style.maxWidth = "90px";
            percentInput.value = v ?? "";
            percentInput.placeholder = v ?? "Custom";

            const percentCell = document.createElement("td");
            percentCell.appendChild(percentInput);

            const totalFeeCell = document.createElement("td");
            const terminFeeCell = document.createElement("td");

            totalFeeCell.textContent = "Rp 0";
            terminFeeCell.textContent = "Rp 0";

            tr.innerHTML = nameCell;
            tr.appendChild(percentCell);
            tr.appendChild(totalFeeCell);
            tr.appendChild(terminFeeCell);

            tbody.appendChild(tr);

            inputElements.push({ input: percentInput, totalFeeCell, terminFeeCell });

            percentInput.addEventListener("input", () => {
                updateTotals();
                updateCalculations();
            });
        });

        table.appendChild(tbody);
        container.appendChild(table);
        container.appendChild(warning);

        updateTotals();
        updateCalculations();
    });

    function updateTotals() {
        const total = inputElements.reduce((sum, el) => sum + Number(el.input.value || 0), 0);

        totalDisplay.textContent = `Total: ${total}%`;
        terminValHidden.value = JSON.stringify(inputElements.map(el => Number(el.input.value || 0)));
        totalPercentageHidden.value = total;

        if (total > 100) {
            warning.textContent = "Persentase tidak bisa melebihi 100%";
            warning.style.display = "block";
            totalDisplay.style.color = "red";
        } else if (total < 100) {
            warning.textContent = "Persentase harus mencapai 100%";
            warning.style.display = "block";
            totalDisplay.style.color = "orange";
        } else {
            warning.style.display = "none";
            totalDisplay.style.color = "black";
        }
    }

    // Fee Calculation
    function updateCalculations() {
        const base = parseInt(baseHidden.value || 0);
        const assist = parseInt(assistHidden.value || 0);
        const ope = parseInt(opeHidden.value || 0);
        const total = parseInt(totalPercentHidden.value || 0);

        if(!base || total !== 100) {
            inputElements.forEach(el => {
                el.totalFeeCell.textContent = "Rp 0";
            });
        }

        let finalTotal = 0;

        inputElements.forEach(el => {
            const percent = Number(el.input.value || 0);
            const sub = baseFee + assistanceFee + opeFee;
            const total = sub * (percent / 100);

            el.totalFeeCell.textContent = "Rp " + idrFormatter.format(sub);
            el.terminFeeCell.textContent = "Rp " + idrFormatter.format(total);

            finalTotal += total;
        });

        terminFeeHidden.value = Math.round(finalTotal);
    }

    // Update (Auto-fill): FYE & Termin
    document.addEventListener("DOMContentLoaded", function() {
        renderFye(dateArray);
    });

    // Submit Validation: FYE & Termin
    form.addEventListener("submit", e => {
        const fyeInputs = document.querySelectorAll("fye-input");

        const values = [];
        let hasError = false;
        const duplicateCheck = new Set();

        fyeInputs.forEach(input => {
            input.classList.remove("is-invalid");
            const val = input.value.trim();

            // Check for empty value(s)
            if (val === "" ) {
                input.classList.add("is-invalid");
            }

            // Check for duplicates
            if (duplicateCheck.has(val.toLowerCase())) {
                input.classList.add("is-invalid");
                hasError = true;
            } else if(val !== "") {
                duplicateCheck.add(val.toLowerCase());
            }

            if (val != "") {
                values.push(val);
            }
        });

        if (hasError) {
            e.preventDefault();
            errorFye.classList.remove("d-none");
            errorFye.textContent = "Error: hapus tahun buku kosong dan duplikat.";
            return;
        }

        errorFye.classList.add("d-none");

        hiddenFye.value = JSON.stringify(values);
    });
</script>

{% endblock %}